/*!build time : 2013-10-17 12:26:47 AM*/
KISSY.add("gallery/droplist/0.1/datalist",function(a){function b(){this._init.apply(this,arguments)}var c="_id",d="_index",e={dataSource:null};return a.augment(b,a.EventTarget,{_init:function(b){b=this.cfg=a.merge(e,b),this._initSelected=b.selected},dataFactory:function(a){this._dataFactory(a)},getDataByValue:function(b){if(this._list){var c;return a.each(this._list,function(a){return a.value===b?(c=a,!1):void 0}),c}},filter:function(b,c){var d=this,e=[];a.each(d._list,function(c){var d=!1;a.each(b,function(a,b){return-1!==c[b].indexOf(a)?(d=!0,!1):void 0}),d&&e.push(c)}),c&&c(e)},select:function(a){var b;void 0!=a&&(b=this._dataMap[a]);var c=this.selected;c==b||c&&b&&b.value===c.value||(this.selected=b,this.fire("selected",{data:b}))},getSelectedData:function(){return this.selected||this._initSelected},_dataFactory:function(b){var e=this,f=e.getSelectedData(),g=[],h=this._dataMap={};e.selected=void 0,a.each(b,function(b,i){var j=a.guid();void 0===b[c]&&(b[c]=j),b[d]=i,h[j]=b,g.push(b),f&&b.value==f.value&&e.select(j)}),delete e._initSelected,this._list=g}}),b}),KISSY.add("gallery/droplist/0.1/lap",function(a){function b(){var b=a.makeArray(arguments);a.each(b.shift(),function(a){a.apply(null,b)})}function c(b,c){var e=this,f=a.merge(d,c);e.handleData=[].concat(b),e.cfg=f,e.doIndex=-1,e.fnHandlers=[],e.fnBatches=[],e.fnCallbacks=[],e.duration=f.duration||300,e.delay=f.delay||30,e.isPause=!1,e.isStop=!1}var d={duration:300,delay:50},e=[];return a.augment(c,a.EventTarget,{handle:function(a){this.fnHandlers.push(a)},batch:function(a){this.fnBatches.push(a)},then:function(a){this.fnCallbacks.push(a)},start:function(){var a=this;if(a.isStop)throw new Error("the task has complete.");a.isPause=!1,setTimeout(function(){a._process()},0)},process:function(){a.later(this._process,0)},pause:function(){this.isPause=!0},stop:function(){this.isStop||this._stop()},_stop:function(){this.isStop=!0,b(this.fnCallbacks)},_process:function(){var a=this,c=a.handleData,d=a.fnHandlers;if(!(a.isStop||a.isPause&&c.length>0)){var e=+new Date+a.duration,f=-1;do{var g=c.shift();void 0!==g&&(a.doIndex++,f++,b(d,g,a.doIndex,f))}while(c.length>0&&e>+new Date&&!a.isPause&&!a.isStop);b(a.fnBatches,a.doIndex),0!=c.length||a.isStop?setTimeout(function(){a._process()},a.delay):a._stop()}}}),function(a,b){var d=new c(a,b);return e.push(d),d}}),KISSY.add("gallery/droplist/0.1/viewscroll",function(a,b,c,d){function e(){this.init.apply(this,arguments)}var f=a.DOM,g=a.Event,h="",i={selectedCls:"selected",focusCls:"focus",itemCls:"drop-menuitem",prefixId:"dropmenu-item",menuItem:'<li class="drop-menuitem" id="dropmenu-item{{_id}}" data-id="{{_id}}">{{text}}</li>'};return a.augment(e,a.EventTarget,{init:function(a){var c=this,d=new b({prefixCls:"dropmenu-"});c.layer=d,c.elList=f.create("<ul></ul>"),c.datalist=a,d.on("afterRenderUI",function(){c._UIRender()}),this.on("hide",function(){c.focused=void 0})},render:function(b){if(!b||0==b.length)return!1;var c=this,e=c.lap,g=document.createDocumentFragment();return e&&e.stop(),c.lap?(a.later(function(){c.render(b)},20),!0):(f.html(c.elList,h),e=c.lap=d(b,{duration:30}),c._list=b,e.handle(function(a){var b=c._itemRender(a);b&&g.appendChild(b)}),e.batch(function(){f.append(g,c.elList)}),e.then(function(){f.append(g,c.elList),c.lap=null}),e.start(),!0)},_itemRender:function(a){if(!a)return null;var b=c(i.menuItem).render(a),d=f.create(b),e=this.datalist.selected;return e&&e.value===a.value&&this._selectByElement(d,a),d},_UIRender:function(){var a=this,b=a.layer,c=a.elList,d=b.get("el"),e=b.get("contentEl");e.append(c),a._bindList(),a.elWrap=d,a.fire("UIRender")},_bindList:function(){var a=this,b=a.elList;g.on(b,"click",function(b){var c=b.target;if(f.hasClass(c,i.itemCls)||(c=f.parent(c,i.itemCls)),c){b.stopPropagation();var d=f.attr(c,"data-id");a.fire("itemSelect",{id:d})}})},select:function(a){var b=a?a._id:!1,c=b!==!1&&f.get("#"+i.prefixId+b,this.elList);c||(c=a=void 0),this._selectByElement(c,a),this.fire("select",{data:a})},_selectByElement:function(a,b){this._setElementClass(a,this.selected,i.selectedCls),this.selected=b,this.focused=b},_focus:function(a){var b=a?a._id:!1,c=b!==!1&&f.get("#"+i.prefixId+b,this.elList);c||(c=a=void 0),this._setElementClass(c,this.focused,i.focusCls),this.focused=a,this.fire("focus",{data:a})},_setElementClass:function(a,b,c){if(b){var d=f.get("#"+i.prefixId+b._id,this.elList);d&&f.removeClass(d,c)}a&&f.addClass(a,c)},focusNext:function(){var b,c=this.focused;if(c){var d=0;a.each(this._list,function(a,b){return a.value==c.value?(d=b,!1):void 0}),b=this._list[d+1]}else b=this._list[0];this._focus(b)},focusPrevious:function(){var b,c=this.focused;if(c){var d=0;a.each(this._list,function(a,b){return a.value==c.value?(d=b,!1):void 0}),b=this._list[d-1]}else b=this._list[this._list.length-1];this._focus(b)},selectFocused:function(){this.focused&&this.fire("itemSelect",{id:this.focused._id})},emptyRender:function(){this.visible(!1)},visible:function(a){a?(this.layer.show(),this.fire("show")):(this.layer.hide(),this.fire("hide"))},align:function(a){this.layer.set("align",a)},scrollIntoView:function(){}}),e},{requires:["overlay","template","./lap"]}),KISSY.add("gallery/droplist/0.1/droplist",function(a,b,c,d,e){function f(){this._init.apply(this,arguments)}var g="",h={hideDelay:100,fieldName:"",insertion:document.body,fnDataAdapter:function(a){return a},fnReceive:function(a){return a}},i={wrap:'<div class="droplist"><div class="drop-trigger"><i class="caret"></i></div><div class="drop-wrap"><input class="drop-text" type="text" name="{name}-text" /></div><input class="drop-value" type="hidden" /></div>',textCls:"drop-text",valueCls:"drop-value",triggerCls:"drop-trigger"},j=[9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,45,91,93];return a.augment(f,a.EventTarget,{_init:function(b){var c=a.merge(h,b);this.cfg=c,c.srcNode&&this._buildWrap(c.srcNode),this._data=new d({selected:c.selectedItem}),this._view=new e(this._data),this._bindControl(),this.isVisible=!1,this.timer={search:null,hide:null}},render:function(){var c=this,d=c.cfg,e=c.elWrap;if(e||(c._buildWrap(),e=c.elWrap),!b.parent(e)){var f=d.insertion;a.isFunction(f)?f(e):f.appendChild?f.appendChild(e):a.isString(f)&&(f=b.get(f),f&&f.appendChild&&f.appendChild(e))}this._bindElement();var g=d.dataSource;a.isArray(g)?c.dataFactory(g):a.isString(g)?this._fetch({url:g},function(a){c.dataFactory(a)}):a.isPlainObject(g)?this._fetch(g,function(a){c.dataFactory(a)}):a.isFunction(g)&&g(function(a){c.dataFactory(a)})},dataFactory:function(a){var b=this.cfg.fnDataAdapter(a);this._data.dataFactory(b)},_fetch:function(b,c){var d=this,e=a.now();if(d._lastModify=e,!b.url)throw new Error("there is no data");var f=a.merge({type:"GET",dataType:"json",error:function(){alert("\u8bf7\u6c42\u6570\u636e\u53d1\u751f\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002")}},b),g=b.success||d.cfg.fnReceive;f.success=function(a){var b=g(a);b&&(b.result?c&&c(b.list):alert(b.msg))},a.io(f)},_bindElement:function(){var a=this,b=this.elText,d=this.elValue,e=a._view,f=a._data;a.on("toggle",function(){var b=a.isVisible;a._keepFocus(),b&&a.hide()}),c.on(this.elTrigger,"click",function(){a.fire("toggle")}),c.on(b,"focus",function(){a._stopHideTimer(),a.isVisible||(e.render(f._list),a.show())}),d&&a.on("change",function(a){var b=a.data,c=b?b.value:"";d.value=c}),a._bindInput(b)},_bindControl:function(){var a=this,d=this._view,e=this._data;d.on("UIRender",function(){var a=d.elWrap;b.unselectable(a),c.on(a,"mousedown",function(a){a.preventDefault()})}),d.on("itemSelect",function(b){var c=b.id;a._data.select(c)}),d.on("focus",function(b){var c=b.data;c?a._fillText(c):a._fillText(e.selected)}),e.on("selected",function(b){var c=b.data;d.select(c),a._fillText(c),a.fire("change",{data:c}),a.hide()})},_keepFocus:function(){c.fire(this.elText,"focus")},selectByValue:function(a){var b=this.getDataByValue(a);this._data.select(b&&b._id)},getDataByValue:function(a){return this._data.getDataByValue(a)},getSelectedData:function(){return this._data.getSelectedData()},_fillText:function(a){var b=this.elText,c=a?a.text:g;b.value=c},hide:function(){this._view.visible(this.isVisible=!1)},show:function(){var a=this._view,b=this.elWrap;a.align({node:b,points:["bl","tl"],offset:[0,0]}),a.visible(this.isVisible=!0)},_bindInput:function(b){var d=this,e=d._data,f=d._view;c.on(b,"blur",function(){d._fillText(e.selected),d._latencyHide()}),c.on(b,"keydown",function(a){var b=a.keyCode;return 9==b||27==b?(d._fillText(e.selected),d.hide(),void 0):38==b||40==b?(a.preventDefault(),d.isVisible?(40===b?f.focusNext():f.focusPrevious(),void 0):(f.render(e._list),d.show(),void 0)):13==b?(f.selectFocused(),void 0):void 0}),c.on(b,"keyup",function(c){var g=c.keyCode;if(!(a.inArray(g,j)||g>=112&&123>=g)){var h=b.value;return h?(e.filter({text:h},function(a){var b=e.selected;e.selected=f.focused=void 0,void 0!==b&&d.fire("change",{data:void 0}),0===a.length?f.emptyRender():(f.render(a),d.show())}),void 0):(f.render(e._list),d.show(),void 0)}})},_stopHideTimer:function(){var a=this.timer;a.hide&&(a.hide.cancel(),a.hide=null)},_latencyHide:function(){var b=this,c=b.timer;b._stopHideTimer(),c.hide=a.later(function(){b.hide()},b.cfg.hideDelay)},_buildWrap:function(c){if(c=b.get(c),!c){var d=a.substitute(i.wrap);c=b.create(d)}var e=b.get("."+i.triggerCls,c),f=b.get("."+i.textCls,c),g=b.get("."+i.valueCls,c),h=this.cfg.fieldName;h&&b.attr(g,"name",h),this.elWrap=c,this.elValue=g,this.elText=f,this.elTrigger=e}}),f},{requires:["dom","event","./datalist","./viewscroll"]}),KISSY.add("gallery/droplist/0.1/index",function(a,b,c,d){return d.decorate=function(c,e){var f=[];a.each(c.options,function(a){f.push({text:a.text,value:a.value})});var g=c.options[c.selectedIndex],h=a.merge({selectedItem:{value:g.value,text:g.text},fieldName:b.attr(c,"name"),dataSource:f,insertion:function(a){b.replaceWith(c,a)}},e);return new d(h)},d},{requires:["dom","event","./droplist"]});